// Prisma schema for Neon Postgres
// Uses `POSTGRES_PRISMA_URL` from env (Vercel/Local)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
}

model Product {
  id        String   @id @default(cuid())
  slug      String   @unique
  title     String
  price     Int      // store minor units (e.g., A$229 => 22900) or whole units as per app
  seller    String
  rating    Float?
  type      ProductType
  img       String
  barcode   String?
  description String?
  images     String[]
  stockCount Int      @default(0)
  serviceDurationMinutes Int?
  serviceOpenTime  String?
  serviceCloseTime String?
  serviceOpenDays  String[] @default([])
  serviceDailyCapacity Int?
  ownerId   Int?
  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  OrderItems OrderItem[]
  CartItems  CartItem[]

  @@unique([ownerId, barcode])
}

enum ProductType {
  goods
  service
}

model Order {
  id            String      @id @default(cuid())
  buyerId       Int?
  sellerId      Int?
  total         Int
  status        OrderStatus @default(pending)
  customerName  String?
  customerEmail String?
  address       String?
  customerPhone String?
  accessCode    String?     @unique
  createdAt     DateTime    @default(now())

  items OrderItem[]
  tickets SupportTicket[] @relation("OrderTickets")
  refundRequests RefundRequest[]

  buyer  User? @relation("OrderBuyer", fields: [buyerId], references: [id])
  seller User? @relation("OrderSeller", fields: [sellerId], references: [id])
  reviews OrderReview[]
}

enum OrderStatus {
  pending
  scheduled
  paid
  shipped
  completed
  cancelled
  refunded
}

enum RefundStatus {
  requested
  reviewing
  accepted
  rejected
  refunded
}

enum SupportTicketStatus {
  open
  in_progress
  resolved
  closed
}

enum SupportTicketType {
  general
  order
  service
  billing
}

enum AnnouncementAudience {
  all
  buyers
  sellers
  drivers
  admins
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  productId String
  title     String
  price     Int
  quantity  Int
  appointmentAt DateTime?
  appointmentStatus String?
  appointmentAlternates String? // JSON string array of ISO datetimes proposed by seller

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
  tickets SupportTicket[] @relation("OrderItemTickets")
  refundRequests RefundRequest[]
}

model Cart {
  id        String   @id @default(cuid())
  userId    Int?
  createdAt DateTime @default(now())

  items CartItem[]
}

model CartItem {
  id        String  @id @default(cuid())
  cartId    String
  productId String
  quantity  Int      @default(1)
  meta      String?

  cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
}

model Category {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  products  Product[]
}

model User {
  id         Int       @id @default(autoincrement())
  email      String    @unique
  name       String?
  image      String?
  googleSub  String?   @unique
  role       UserRole  @default(driver)
  phoneNo    String?   // legacy column in existing DB, keep optional here
  ABN        String?   // legacy column in existing DB, keep optional here
  bio        String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime? @updatedAt

  // MFA (Time-based One-Time Password)
  mfaEnabled     Boolean   @default(false)
  mfaSecret      String?
  mfaTempSecret  String?

  reputation UserReputation?
  buyerReports  NegativeReport[] @relation("BuyerReports")
  sellerReports NegativeReport[] @relation("SellerReports")

  sellingOrders Order[] @relation("OrderSeller")
  buyingOrders  Order[] @relation("OrderBuyer")
  orderReviewsGiven OrderReview[] @relation("OrderReviewBuyer")
  orderReviewsReceived OrderReview[] @relation("OrderReviewSeller")
  blogPosts BlogPost[]

  supportTicketsCreated SupportTicket[] @relation("TicketRequester")
  supportTicketsAssigned SupportTicket[] @relation("TicketSeller")
  supportMessages SupportMessage[]
  announcements Announcement[] @relation("AnnouncementAuthor")
  refundRequestsMade RefundRequest[] @relation("RefundBuyer")
  refundRequestsReceived RefundRequest[] @relation("RefundSeller")

  // Relations
  dockets        Docket[]
  shifts         Shift[]
  maintenance    MaintenanceRequest[]
  accidents      AccidentReport[]
  fuelReceipts   FuelReceipt[]
  payments       Payment[]
}

model Truck {
  id        String   @id @default(cuid())
  rego      String   @unique
  name      String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  dockets   Docket[]
  shifts    Shift[]
  maint     MaintenanceRequest[]
  accidents AccidentReport[]
  receipts  FuelReceipt[]
}

model Docket {
  id          String   @id @default(cuid())
  driverId    Int
  truckId     String?
  date        DateTime
  project     String?
  startTime   String?
  endTime     String?
  hours       Float?
  details     String?
  files       String[]
  createdAt   DateTime @default(now())

  driver User  @relation(fields: [driverId], references: [id], onDelete: Cascade)
  truck  Truck? @relation(fields: [truckId], references: [id])
}

model Shift {
  id          String   @id @default(cuid())
  driverId    Int
  truckId     String?
  date        DateTime
  startTime   String
  endTime     String
  breakMin    Int      @default(0)
  totalHours  Float
  createdAt   DateTime @default(now())

  driver User  @relation(fields: [driverId], references: [id], onDelete: Cascade)
  truck  Truck? @relation(fields: [truckId], references: [id])
}

model MaintenanceRequest {
  id          String   @id @default(cuid())
  driverId    Int
  truckId     String?
  date        DateTime @default(now())
  category    String
  severity    String?
  description String
  status      String   @default("open")
  files       String[]

  driver User  @relation(fields: [driverId], references: [id], onDelete: Cascade)
  truck  Truck? @relation(fields: [truckId], references: [id])
}

model AccidentReport {
  id            String   @id @default(cuid())
  driverId      Int
  truckId       String?
  occurredAt    DateTime
  location      String?
  description   String
  injuries      Boolean  @default(false)
  policeReport  Boolean  @default(false)
  files         String[]
  status        String   @default("submitted")

  driver User  @relation(fields: [driverId], references: [id], onDelete: Cascade)
  truck  Truck? @relation(fields: [truckId], references: [id])
}

model FuelReceipt {
  id        String   @id @default(cuid())
  driverId  Int
  truckId   String?
  date      DateTime
  liters    Float
  amount    Int      // minor units (cents)
  odometer  Int?
  fileUrl   String?

  driver User  @relation(fields: [driverId], references: [id], onDelete: Cascade)
  truck  Truck? @relation(fields: [truckId], references: [id])
}

model Payment {
  id          String   @id @default(cuid())
  driverId    Int
  periodStart DateTime
  periodEnd   DateTime
  gross       Int // cents
  net         Int // cents
  status      String   @default("pending")
  paidAt      DateTime?
  createdAt   DateTime @default(now())

  driver  User     @relation(fields: [driverId], references: [id], onDelete: Cascade)
  payslips Payslip[]
}

model Payslip {
  id        String   @id @default(cuid())
  paymentId String
  url       String
  createdAt DateTime @default(now())

  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)
}

enum UserRole {
  driver
  manager
  admin
}

model BlogPost {
  id         String   @id @default(cuid())
  slug       String   @unique
  title      String
  content    String   // markdown/plain text
  coverImage String?
  tags       String[]
  published  Boolean  @default(false)
  authorId   Int?
  author     User?    @relation(fields: [authorId], references: [id])
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model UserReputation {
  userId        Int     @id
  negativeCount Int     @default(0)
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model NegativeReport {
  id       String   @id @default(cuid())
  buyerId  Int
  sellerId Int
  orderId  String?
  reason   String
  createdAt DateTime @default(now())

  buyer  User  @relation("BuyerReports", fields: [buyerId], references: [id], onDelete: Cascade)
  seller User  @relation("SellerReports", fields: [sellerId], references: [id], onDelete: Cascade)
}

model OrderReview {
  id        String  @id @default(cuid())
  orderId   String  @unique
  buyerId   Int
  sellerId  Int
  rating    Int
  feedback  String
  createdAt DateTime @default(now())

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  buyer User  @relation("OrderReviewBuyer", fields: [buyerId], references: [id], onDelete: Cascade)
  seller User @relation("OrderReviewSeller", fields: [sellerId], references: [id], onDelete: Cascade)
}

model Announcement {
  id          String               @id @default(cuid())
  title       String
  body        String
  audience    AnnouncementAudience @default(all)
  pinned      Boolean              @default(false)
  startAt     DateTime?
  endAt       DateTime?
  publishedAt DateTime             @default(now())
  authorId    Int?

  author User? @relation("AnnouncementAuthor", fields: [authorId], references: [id])
}

model SupportTicket {
  id           String              @id @default(cuid())
  subject      String
  type         SupportTicketType   @default(general)
  status       SupportTicketStatus @default(open)
  priority     String?             @default("normal")
  orderId      String?
  orderItemId  String?
  requesterId  Int
  sellerId     Int?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  order     Order?     @relation("OrderTickets", fields: [orderId], references: [id])
  orderItem OrderItem? @relation("OrderItemTickets", fields: [orderItemId], references: [id])
  requester User       @relation("TicketRequester", fields: [requesterId], references: [id])
  seller    User?      @relation("TicketSeller", fields: [sellerId], references: [id])
  messages  SupportMessage[]
}

model SupportMessage {
  id        String   @id @default(cuid())
  ticketId  String
  authorId  Int?
  body      String
  attachments String[] @default([])
  createdAt DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author User?         @relation(fields: [authorId], references: [id])
}

model RefundRequest {
  id          String        @id @default(cuid())
  orderId     String
  orderItemId String?
  buyerId     Int
  sellerId    Int?
  amount      Int?
  reason      String
  status      RefundStatus  @default(requested)
  resolution  String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  order     Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderItem OrderItem? @relation(fields: [orderItemId], references: [id])
  buyer     User       @relation("RefundBuyer", fields: [buyerId], references: [id])
  seller    User?      @relation("RefundSeller", fields: [sellerId], references: [id])
}
